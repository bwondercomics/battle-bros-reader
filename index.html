<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Battle Bros Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root {
  --primary:#00d9ff;
  --secondary:#ff00ea;
  --accent:#ffed00;
  --bg-dark:#0a0a12;
  --bg-panel:#1a1a2e;
  --text:#ffffff;
  --text-glow:#00d9ff;
  --danger:#ff3838;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

@keyframes glitchText {
  0% { text-shadow: 2px 2px 0 var(--primary), -2px -2px 0 var(--secondary); }
  25% { text-shadow: -2px 2px 0 var(--secondary), 2px -2px 0 var(--primary); }
  50% { text-shadow: 2px -2px 0 var(--primary), -2px 2px 0 var(--secondary); }
  75% { text-shadow: -2px -2px 0 var(--secondary), 2px 2px 0 var(--primary); }
  100% { text-shadow: 2px 2px 0 var(--primary), -2px -2px 0 var(--secondary); }
}

@keyframes scanline {
  0% { transform: translateY(-100%); }
  100% { transform: translateY(100%); }
}

@keyframes neonPulse {
  0%, 100% { 
    box-shadow: 0 0 5px var(--primary), 0 0 10px var(--primary), 0 0 15px var(--primary),
                inset 0 0 5px rgba(0,217,255,0.2);
  }
  50% { 
    box-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary), 0 0 30px var(--primary),
                inset 0 0 10px rgba(0,217,255,0.4);
  }
}

@keyframes floatBadge {
  0%, 100% { transform: translateY(0px) rotate(0deg); }
  50% { transform: translateY(-5px) rotate(5deg); }
}

@keyframes pixelShift {
  0%, 100% { transform: translate(0, 0); }
  25% { transform: translate(2px, 0); }
  50% { transform: translate(0, 2px); }
  75% { transform: translate(-2px, 0); }
}

@keyframes slideInTop {
  from { transform: translateY(-100px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

html, body {
  margin: 0;
  height: 100%;
  font-family: 'Righteous', sans-serif;
  background: var(--bg-dark);
  color: var(--text);
  overflow-x: hidden;
  touch-action: manipulation;
}

body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    repeating-linear-gradient(0deg, rgba(0,217,255,0.03) 0px, transparent 2px, transparent 4px),
    radial-gradient(circle at 20% 80%, rgba(0,217,255,0.1), transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255,0,234,0.1), transparent 50%);
  pointer-events: none;
  z-index: 0;
}

body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: linear-gradient(transparent 50%, rgba(0,217,255,0.02) 50%);
  background-size: 100% 4px;
  pointer-events: none;
  z-index: 1;
  animation: scanline 8s linear infinite;
  opacity: 0.3;
}

header.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 20px;
  background: linear-gradient(135deg, rgba(10,10,18,0.95), rgba(26,26,46,0.95));
  border-bottom: 3px solid var(--primary);
  position: sticky;
  top: 0;
  z-index: 20;
  backdrop-filter: blur(10px);
  box-shadow: 0 0 20px rgba(0,217,255,0.5);
  animation: slideInTop 0.6s ease-out;
}

.brand {
  display: flex;
  align-items: center;
  gap: 15px;
}

.logo {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--bg-panel), var(--bg-dark));
  border: 3px solid var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  <!-- clip-path: polygon(15% 0%, 85% 0%, 100% 15%, 100% 85%, 85% 100%, 15% 100%, 0% 85%, 0% 15%); -->
  font-weight: 900;
  font-size: 28px;
  color: var(--primary);
  text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary);
  transition: all 0.3s;
  animation: neonPulse 2s ease-in-out infinite;
  font-family: 'Bebas Neue', sans-serif;
  letter-spacing: 2px;
}

.logo:hover {
  transform: scale(1.1);
  animation: glitchText 0.3s infinite;
}

.logo-corner {
  position: absolute;
  width: 8px;
  height: 8px;
  background: var(--accent);
  box-shadow: 0 0 5px var(--accent);
}

.logo-corner.tl { top: -2px; left: -2px; }
.logo-corner.tr { top: -2px; right: -2px; }
.logo-corner.bl { bottom: -2px; left: -2px; }
.logo-corner.br { bottom: -2px; right: -2px; }

.title h1 {
  margin: 0;
  font-size: 32px;
  letter-spacing: 7px;
  <!-- font-family: 'Bebas Neue', sans-serif; -->
  text-transform: uppercase;
  background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
  <!-- background-size: 200% 100%; -->
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px rgba(0,217,255,0.5));
  animation: pixelShift 3s linear infinite;
}

.title .subtitle {
  margin: 0;
  font-size: 11px;
  color: var(--accent);
  font-family: 'Righteous', sans-serif;
  text-transform: uppercase;
  letter-spacing: 3px;
  text-shadow: 0 0 5px var(--accent);
}


select#chapter {
  background: linear-gradient(135deg, rgba(0,217,255,0.1), rgba(255,0,234,0.1));
  color: var(--text);
  border: 2px solid var(--primary);
  padding: 8px 14px;
  clip-path: polygon(6px 0%, 100% 0%, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0% 100%, 0% 6px);
  min-width: 160px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  font-family: 'Righteous', sans-serif;
}

select#chapter:hover {
  background: linear-gradient(135deg, rgba(0,217,255,0.2), rgba(255,0,234,0.2));
  box-shadow: 0 0 15px rgba(0,217,255,0.5);
}

select#chapter option {
  background: var(--bg-panel);
  color: var(--text);
}

main {
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding: 16px;
  max-width: 1400px;
  margin: 16px auto;
  position: relative;
  z-index: 2;
}

.viewport {
  background: linear-gradient(135deg, rgba(26,26,46,0.6), rgba(10,10,18,0.8));
  border: 3px solid var(--primary);
  clip-path: polygon(15px 0%, 100% 0%, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0% 100%, 0% 15px);
  overflow: hidden;
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 70vh;
  box-shadow: 0 0 30px rgba(0,217,255,0.4);
  touch-action: none;
}

.stage {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: center;
  cursor: grab;
  touch-action: none;
  transition: opacity 0.2s ease-out;
}

.stage.transitioning {
  opacity: 0.7;
}

.page {
  display: flex;
  justify-content: center;
  align-items: center;
  background: #000;
  position: relative;
  overflow: hidden;
  border: 2px solid rgba(0,217,255,0.3);
}

.page img {
  display: block;
  max-width: 100%;
  max-height: 70vh;
  object-fit: contain;
  user-select: none;
  -webkit-user-drag: none;
  pointer-events: none;
  touch-action: none;
}

.spinner {
  position: absolute;
  width: 50px;
  height: 50px;
  border: 3px solid transparent;
  border-top: 3px solid var(--primary);
  border-right: 3px solid var(--secondary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: linear-gradient(135deg, rgba(26,26,46,0.9), rgba(10,10,18,0.9));
  backdrop-filter: blur(10px);
  border: 3px solid var(--primary);
  clip-path: polygon(12px 0%, 100% 0%, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0% 100%, 0% 12px);
  box-shadow: 0 0 20px rgba(0,217,255,0.4);
}

.controls .left,
.controls .right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn {
  height: 44px;
  min-width: 44px;
  padding: 0 16px;
  background: linear-gradient(135deg, rgba(0,217,255,0.15), rgba(255,0,234,0.15));
  border: 2px solid var(--primary);
  clip-path: polygon(5px 0%, 100% 0%, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0% 100%, 0% 5px);
  color: var(--text);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 900;
  text-transform: uppercase;
  transition: all 0.2s;
  font-family: 'Bebas Neue', sans-serif;
  letter-spacing: 1px;
  touch-action: manipulation;
  box-shadow: 0 0 10px rgba(0,217,255,0.3);
}

.btn:hover:not(:disabled) {
  background: linear-gradient(135deg, rgba(0,217,255,0.3), rgba(255,0,234,0.3));
  box-shadow: 0 0 20px rgba(0,217,255,0.6);
  transform: translateY(-2px);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.btn.primary {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  border: none;
  color: var(--bg-dark);
  font-size: 14px;
  box-shadow: 0 0 20px rgba(0,217,255,0.8);
}

.btn.primary:hover:not(:disabled) {
  box-shadow: 0 0 30px rgba(0,217,255,1);
  transform: translateY(-2px) scale(1.05);
}

.status {
  color: var(--accent);
  font-size: 13px;
  font-weight: 900;
  text-transform: uppercase;
  font-family: 'Bebas Neue', sans-serif;
  letter-spacing: 1px;
  padding: 6px 12px;
  background: linear-gradient(135deg, rgba(255,237,0,0.1), rgba(255,237,0,0.05));
  border: 2px solid var(--accent);
  clip-path: polygon(4px 0%, 100% 0%, 100% calc(100% - 4px), calc(100% - 4px) 100%, 0% 100%, 0% 4px);
  box-shadow: 0 0 10px rgba(255,237,0,0.3);
  white-space: nowrap;
}

.progress-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: rgba(0,217,255,0.2);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
  transition: width 0.3s ease-out;
  box-shadow: 0 0 10px var(--primary);
}

.shortcuts {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: linear-gradient(135deg, rgba(26,26,46,0.95), rgba(10,10,18,0.95));
  border: 2px solid var(--primary);
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 11px;
  color: var(--text);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  z-index: 30;
  backdrop-filter: blur(10px);
  max-width: 200px;
}

.shortcuts.show {
  opacity: 1;
}

.shortcuts div {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  margin: 4px 0;
}

.shortcuts kbd {
  background: rgba(0,217,255,0.2);
  padding: 2px 6px;
  border-radius: 3px;
  border: 1px solid var(--primary);
  font-family: monospace;
  font-size: 10px;
}

.hidden {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

body.fullscreen-active main {
  position: fixed;
  inset: 0;
  margin: 0;
  padding: 0;
  max-width: none;
  z-index: 100;
}

body.fullscreen-active .viewport {
  width: 100vw;
  height: 100vh;
  clip-path: none;
  border: none;
  margin: 0;
  padding: 0;
}

body.fullscreen-active .page img {
  max-height: 100vh;
}

body.fullscreen-active header.topbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 110;
  transition: opacity 0.3s, transform 0.3s;
}

body.fullscreen-active .controls {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  max-width: 90vw;
  z-index: 110;
  transition: opacity 0.3s, transform 0.3s;
}

body.fullscreen-active header.topbar.hidden {
  transform: translateY(-100%);
}

body.fullscreen-active .controls.hidden {
  transform: translateX(-50%) translateY(150%);
}

@media(max-width:900px) {
  .controls {
    flex-direction: column;
    gap: 10px;
  }
  .controls .left,
  .controls .right {
    width: 100%;
    justify-content: space-between;
  }
  .title h1 {
    font-size: 22px;
  }
  .title .subtitle {
    font-size: 8px;
  }
  select#chapter {
    min-width: 130px;
    font-size: 11px;
  }
  .btn {
    height: 40px;
    min-width: 40px;
    font-size: 11px;
    padding: 0 12px;
  }
  .status {
    font-size: 11px;
  }
  .shortcuts {
    display: none;
  }
}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <div class="logo">BB</div>
    <div class="title">
      <h1>BATTLE BROS</h1>
      <p class="subtitle">/// GUESS WHO'S BACK IN TOWN?  ///</p>
    </div>
  </div>
  <select id="chapter"></select>
</header>

<main>
  <div class="viewport">
    <div class="stage" id="stage">
      <div class="page" id="leftPage">
        <div class="spinner"></div>
        <img src="" alt="" draggable="false">
      </div>
      <div class="page" id="rightPage" style="display:none">
        <div class="spinner"></div>
        <img src="" alt="" draggable="false">
      </div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <div class="controls">
    <div class="left">
      <button class="btn" id="prevBtn">◀ BACK</button>
      <button class="btn" id="nextBtn">NEXT ▶</button>
      <span class="status" id="pageIndicator">PAGE 0 / 0</span>
    </div>
    <div class="right">
      <button class="btn" id="zoomOut">−</button>
      <button class="btn primary" id="fitBtn">⚡ FIT</button>
      <button class="btn" id="zoomIn">+</button>
      <button class="btn" id="fullscreenBtn" title="Press F for fullscreen">⛶</button>
    </div>
  </div>
</main>

<div class="shortcuts" id="shortcuts">
  <div><span>Navigate</span><kbd>← →</kbd></div>
  <div><span>Zoom</span><kbd>+ −</kbd></div>
  <div><span>Fit</span><kbd>0</kbd></div>
  <div><span>Fullscreen</span><kbd>F</kbd></div>
  <div><span>Help</span><kbd>?</kbd></div>
</div>

<script>
(function() {
  'use strict';

  const STORAGE_KEY = 'battleBros_progress';
  
  const chapters = {
    "Chapter 1": ["chapters/01/01.png","chapters/01/02.png","chapters/01/03.png","chapters/01/04.png","chapters/01/05.png","chapters/01/06.png","chapters/01/07.png","chapters/01/08.png"],
    "Chapter 2": ["chapters/02/01.png","chapters/02/02.png","chapters/02/03.png","chapters/02/04.png","chapters/02/05.png","chapters/02/06.png","chapters/02/07.png","chapters/02/08.png"],
    "Chapter 3": ["chapters/03/01.png","chapters/03/02.png","chapters/03/03.png","chapters/03/04.png","chapters/03/05.png","chapters/03/06.png","chapters/03/07.png","chapters/03/08.png","chapters/03/09.png","chapters/03/10.png","chapters/03/11.png","chapters/03/12.png","chapters/03/13.png","chapters/03/14.png","chapters/03/15.png"],
    "Chapter 4": ["chapters/04/01.png","chapters/04/02.png","chapters/04/03.png","chapters/04/04.png","chapters/04/05.png","chapters/04/06.png","chapters/04/07.png","chapters/04/08.png","chapters/04/09.png","chapters/04/10.png"],
    "Chapter 5": ["chapters/05/01.png","chapters/05/02.png","chapters/05/03.png","chapters/05/04.png","chapters/05/05.png","chapters/05/06.png","chapters/05/07.png","chapters/05/08.png","chapters/05/09.png","chapters/05/10.png","chapters/05/11.png","chapters/05/12.png","chapters/05/13.png","chapters/05/14.png","chapters/05/15.png"],
    "Chapter 6": ["chapters/06/01.png","chapters/06/02.png","chapters/06/03.png","chapters/06/04.png","chapters/06/05.png","chapters/06/06.png","chapters/06/07.png","chapters/06/08.png","chapters/06/09.png","chapters/06/10.png","chapters/06/11.png","chapters/06/12.png","chapters/06/13.png","chapters/06/14.png","chapters/06/15.png"],
    "Chapter 7": ["chapters/07/01.png","chapters/07/02.png","chapters/07/03.png","chapters/07/04.png","chapters/07/05.png","chapters/07/06.png","chapters/07/07.png","chapters/07/08.png","chapters/07/09.png","chapters/07/10.png","chapters/07/11.png","chapters/07/12.png","chapters/07/13.png","chapters/07/14.png","chapters/07/15.png"],
    "Chapter 8": ["chapters/08/01.png","chapters/08/02.png","chapters/08/03.png","chapters/08/04.png","chapters/08/05.png","chapters/08/06.png","chapters/08/07.png","chapters/08/08.png","chapters/08/09.png","chapters/08/10.png","chapters/08/11.png","chapters/08/12.png","chapters/08/13.png","chapters/08/14.png","chapters/08/15.png"],
    "Chapter 9": ["chapters/09/01.png","chapters/09/02.png","chapters/09/03.png","chapters/09/04.png","chapters/09/05.png","chapters/09/06.png","chapters/09/07.png","chapters/09/08.png","chapters/09/09.png","chapters/09/10.png","chapters/09/11.png","chapters/09/12.png","chapters/09/13.png","chapters/09/14.png","chapters/09/15.png"]
  };

  // State
  let state = {
    currentChapter: '',
    pages: [],
    pageIndex: 0,
    scale: 1,
    pan: {x: 0, y: 0},
    isDragging: false,
    dragStart: {x: 0, y: 0},
    panStart: {x: 0, y: 0},
    touchStart: null,
    pinchDistance: null,
    pinchScale: 1,
    controlsTimeout: null,
    imageCache: new Map(),
    isTransitioning: false
  };

  // DOM
  const el = {
    chapter: document.getElementById('chapter'),
    stage: document.getElementById('stage'),
    viewport: document.querySelector('.viewport'),
    topbar: document.querySelector('.topbar'),
    controls: document.querySelector('.controls'),
    leftPage: document.getElementById('leftPage'),
    rightPage: document.getElementById('rightPage'),
    leftImg: document.querySelector('#leftPage img'),
    rightImg: document.querySelector('#rightPage img'),
    leftSpinner: document.querySelector('#leftPage .spinner'),
    rightSpinner: document.querySelector('#rightPage .spinner'),
    indicator: document.getElementById('pageIndicator'),
    progress: document.getElementById('progressFill'),
    prevBtn: document.getElementById('prevBtn'),
    nextBtn: document.getElementById('nextBtn'),
    zoomIn: document.getElementById('zoomIn'),
    zoomOut: document.getElementById('zoomOut'),
    fitBtn: document.getElementById('fitBtn'),
    fullscreenBtn: document.getElementById('fullscreenBtn'),
    shortcuts: document.getElementById('shortcuts')
  };

  // Image preloading
  function preloadImage(url) {
    if (state.imageCache.has(url)) return state.imageCache.get(url);
    
    const promise = new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = url;
    });
    
    state.imageCache.set(url, promise);
    if (state.imageCache.size > 30) {
      const first = state.imageCache.keys().next().value;
      state.imageCache.delete(first);
    }
    
    return promise;
  }

  function preloadAhead() {
    const start = state.pageIndex + 2;
    const end = Math.min(start + 10, state.pages.length);
    for (let i = start; i < end; i++) {
      preloadImage(state.pages[i]);
    }
  }

  // Navigation helpers
  function isTwoPageMode() {
    return window.innerWidth >= 900;
  }

  function canShowTwoPages() {
    return isTwoPageMode() && state.pageIndex + 1 < state.pages.length;
  }

  function saveProgress() {
    try {
      const progress = {
        chapter: state.currentChapter,
        page: state.pageIndex,
        timestamp: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
    } catch(e) {}
  }

  function loadProgress() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : null;
    } catch(e) {
      return null;
    }
  }

  // Core functions
  function loadChapter(name, restorePage = 0) {
    if (!chapters[name]) return;
    
    state.currentChapter = name;
    state.pages = chapters[name];
    state.pageIndex = restorePage;
    state.scale = 1;
    state.pan = {x: 0, y: 0};
    
    el.chapter.value = name;
    render();
    preloadAhead();
    saveProgress();
  }

  function prevPage() {
    if (state.isTransitioning) return;
    
    if (isTwoPageMode()) {
      state.pageIndex = Math.max(0, state.pageIndex - 2);
    } else {
      state.pageIndex = Math.max(0, state.pageIndex - 1);
    }
    
    render();
    saveProgress();
  }

  function nextPage() {
    if (state.isTransitioning) return;
    
    const two = isTwoPageMode();
    const total = state.pages.length;
    
    if (two) {
      // If we're at the last single page, don't advance
      if (state.pageIndex === total - 1) return;
      
      // If advancing 2 would go past end, go to last page
      if (state.pageIndex + 2 >= total) {
        state.pageIndex = total - 1;
      } else {
        state.pageIndex += 2;
      }
    } else {
      state.pageIndex = Math.min(total - 1, state.pageIndex + 1);
    }
    
    render();
    saveProgress();
  }

  function render() {
    state.isTransitioning = true;
    el.stage.classList.add('transitioning');
    
    setTimeout(() => {
      el.stage.classList.remove('transitioning');
      state.isTransitioning = false;
    }, 200);
    
    const two = canShowTwoPages();
    const leftUrl = state.pages[state.pageIndex] || '';
    const rightUrl = state.pages[state.pageIndex + 1] || '';
    
    // Update layout
    if (!two) {
      el.rightPage.style.display = 'none';
      loadImage(el.leftImg, el.leftSpinner, leftUrl);
    } else {
      el.rightPage.style.display = '';
      loadImage(el.leftImg, el.leftSpinner, leftUrl);
      loadImage(el.rightImg, el.rightSpinner, rightUrl);
    }
    
    updateUI();
    preloadAhead();
  }

  function loadImage(img, spinner, url) {
    if (!url) return;
    
    spinner.style.display = 'block';
    preloadImage(url)
      .then(() => {
        img.src = url;
        img.onload = () => spinner.style.display = 'none';
      })
      .catch(() => {
        img.src = url;
        img.onload = () => spinner.style.display = 'none';
      });
  }

  function updateUI() {
    const total = state.pages.length;
    const current = state.pageIndex + 1;
    const two = canShowTwoPages();
    
    // Page indicator
    if (two) {
      el.indicator.textContent = `PAGE ${current}-${current + 1} / ${total}`;
    } else {
      el.indicator.textContent = `PAGE ${current} / ${total}`;
    }
    
    // Progress bar
    el.progress.style.width = ((current / total) * 100) + '%';
    
    // Button states
    el.prevBtn.disabled = state.pageIndex === 0;
    el.nextBtn.disabled = state.pageIndex >= total - 1;
  }

  // Transform
  function applyTransform() {
    el.stage.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.scale})`;
  }

  function zoomIn() {
    state.scale = Math.min(3, state.scale * 1.2);
    applyTransform();
  }

  function zoomOut() {
    state.scale = Math.max(0.5, state.scale / 1.2);
    applyTransform();
  }

  function fitToScreen() {
    state.scale = 1;
    state.pan = {x: 0, y: 0};
    applyTransform();
  }

  // Mouse events
  function onPointerDown(e) {
    if (e.pointerType === 'touch') return;
    state.isDragging = true;
    el.stage.style.cursor = 'grabbing';
    state.dragStart = {x: e.clientX, y: e.clientY};
    state.panStart = {...state.pan};
    el.stage.setPointerCapture(e.pointerId);
  }

  function onPointerMove(e) {
    if (!state.isDragging || e.pointerType === 'touch') return;
    state.pan.x = state.panStart.x + (e.clientX - state.dragStart.x);
    state.pan.y = state.panStart.y + (e.clientY - state.dragStart.y);
    applyTransform();
  }

  function onPointerUp(e) {
    if (e.pointerType === 'touch') return;
    state.isDragging = false;
    el.stage.style.cursor = 'grab';
    try { el.stage.releasePointerCapture(e.pointerId); } catch(e) {}
  }

  // Touch events
  function getTouchDist(t) {
    const dx = t[0].clientX - t[1].clientX;
    const dy = t[0].clientY - t[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
  }

  function onTouchStart(e) {
    if (e.touches.length === 1) {
      const t = e.touches[0];
      state.touchStart = {x: t.clientX, y: t.clientY, time: Date.now()};
      
      if (state.scale > 1.01) {
        state.isDragging = true;
        state.dragStart = {x: t.clientX, y: t.clientY};
        state.panStart = {...state.pan};
      }
    } else if (e.touches.length === 2) {
      e.preventDefault();
      state.isDragging = false;
      state.pinchDistance = getTouchDist(e.touches);
      state.pinchScale = state.scale;
      state.touchStart = null;
    }
    showControls();
  }

  function onTouchMove(e) {
    if (e.touches.length === 1 && state.isDragging && state.scale > 1.01) {
      e.preventDefault();
      const t = e.touches[0];
      state.pan.x = state.panStart.x + (t.clientX - state.dragStart.x);
      state.pan.y = state.panStart.y + (t.clientY - state.dragStart.y);
      applyTransform();
    } else if (e.touches.length === 2 && state.pinchDistance) {
      e.preventDefault();
      const dist = getTouchDist(e.touches);
      state.scale = Math.max(0.5, Math.min(3, state.pinchScale * (dist / state.pinchDistance)));
      applyTransform();
    }
  }

  function onTouchEnd(e) {
    if (e.touches.length === 0) {
      const wasPinching = state.pinchDistance !== null;
      
      if (!wasPinching && state.touchStart) {
        const t = e.changedTouches[0];
        const dx = t.clientX - state.touchStart.x;
        const dy = t.clientY - state.touchStart.y;
        const dt = Date.now() - state.touchStart.time;
        
        if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) && dt < 500 && state.scale <= 1.01) {
          dx > 0 ? prevPage() : nextPage();
        }
      }
      
      state.isDragging = false;
      state.touchStart = null;
      state.pinchDistance = null;
    } else if (e.touches.length === 1) {
      state.pinchDistance = null;
    }
  }

  // Wheel zoom
  function onWheel(e) {
    if (e.ctrlKey) {
      e.preventDefault();
      state.scale = Math.max(0.5, Math.min(3, state.scale + (e.deltaY > 0 ? -0.1 : 0.1)));
      applyTransform();
    }
  }

  // Fullscreen
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }

  function showControls() {
    el.topbar.classList.remove('hidden');
    el.controls.classList.remove('hidden');
    
    if (state.controlsTimeout) clearTimeout(state.controlsTimeout);
    
    if (document.fullscreenElement) {
      state.controlsTimeout = setTimeout(() => {
        el.topbar.classList.add('hidden');
        el.controls.classList.add('hidden');
      }, 3000);
    }
  }

  function onMouseMove(e) {
    if (!document.fullscreenElement) return;
    if (e.clientY < 100 || e.clientY > window.innerHeight - 150) {
      showControls();
    }
  }

  function onFullscreenChange() {
    if (document.fullscreenElement) {
      document.body.classList.add('fullscreen-active');
      el.fullscreenBtn.textContent = '✕';
      showControls();
    } else {
      document.body.classList.remove('fullscreen-active');
      el.fullscreenBtn.textContent = '⛶';
      el.topbar.classList.remove('hidden');
      el.controls.classList.remove('hidden');
      if (state.controlsTimeout) clearTimeout(state.controlsTimeout);
    }
  }

  // Keyboard
  let helpTimeout;
  function onKeyDown(e) {
    switch(e.key) {
      case 'ArrowLeft':
        e.preventDefault();
        prevPage();
        break;
      case 'ArrowRight':
        e.preventDefault();
        nextPage();
        break;
      case '+':
      case '=':
        e.preventDefault();
        zoomIn();
        break;
      case '-':
        e.preventDefault();
        zoomOut();
        break;
      case '0':
        e.preventDefault();
        fitToScreen();
        break;
      case 'f':
      case 'F':
        e.preventDefault();
        toggleFullscreen();
        break;
      case '?':
        el.shortcuts.classList.toggle('show');
        if (helpTimeout) clearTimeout(helpTimeout);
        helpTimeout = setTimeout(() => {
          el.shortcuts.classList.remove('show');
        }, 5000);
        break;
    }
  }

  // Init
  function init() {
    // Populate chapters
    Object.keys(chapters).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      el.chapter.appendChild(opt);
    });
    
    // Load saved progress or first chapter
    const saved = loadProgress();
    if (saved && chapters[saved.chapter]) {
      loadChapter(saved.chapter, saved.page);
    } else {
      loadChapter(Object.keys(chapters)[0]);
    }
    
    // Events
    el.chapter.addEventListener('change', e => loadChapter(e.target.value));
    el.prevBtn.addEventListener('click', prevPage);
    el.nextBtn.addEventListener('click', nextPage);
    el.zoomIn.addEventListener('click', zoomIn);
    el.zoomOut.addEventListener('click', zoomOut);
    el.fitBtn.addEventListener('click', fitToScreen);
    el.fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    // Touch fix for buttons
    document.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('touchend', e => {
        e.preventDefault();
        e.stopPropagation();
        btn.click();
      }, {passive: false});
    });
    
    el.stage.addEventListener('pointerdown', onPointerDown);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);
    el.stage.addEventListener('wheel', onWheel, {passive: false});
    
    el.viewport.addEventListener('touchstart', onTouchStart, {passive: false});
    el.viewport.addEventListener('touchmove', onTouchMove, {passive: false});
    el.viewport.addEventListener('touchend', onTouchEnd, {passive: false});
    
    el.viewport.addEventListener('mousemove', onMouseMove);
    document.addEventListener('fullscreenchange', onFullscreenChange);
    document.addEventListener('keydown', onKeyDown);
    
    // Double tap to fit
    let lastTap = 0;
    el.viewport.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTap < 300 && e.touches.length === 0) {
        fitToScreen();
      }
      lastTap = now;
    });
    
    console.log('Battle Bros Reader initialized! Press ? for shortcuts');
  }

  init();
})();
</script>

</body>
</html>
