<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Battle Bros Reader</title>
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#00d9ff;
  --secondary:#ff00ea;
  --accent:#ffed00;
  --bg-dark:#0a0a12;
  --bg-panel:#1a1a2e;
  --text:#ffffff;
  --danger:#ff3838;
}

*{box-sizing:border-box;margin:0;padding:0;}

@keyframes glitchText{0%{text-shadow:2px 2px 0 var(--primary),-2px -2px 0 var(--secondary)}25%{text-shadow:-2px 2px 0 var(--secondary),2px -2px 0 var(--primary)}50%{text-shadow:2px -2px 0 var(--primary),-2px 2px 0 var(--secondary)}75%{text-shadow:-2px -2px 0 var(--secondary),2px 2px 0 var(--primary)}100%{text-shadow:2px 2px 0 var(--primary),-2px -2px 0 var(--secondary)}}
@keyframes scanline{0%{transform:translateY(-100%)}100%{transform:translateY(100%)}}
@keyframes neonPulse{0%,100%{box-shadow:0 0 5px var(--primary),0 0 10px var(--primary)}50%{box-shadow:0 0 10px var(--primary),0 0 20px var(--primary)}}
@keyframes pixelShift{0%,100%{transform:translate(0,0)}25%{transform:translate(2px,0)}50%{transform:translate(0,2px)}75%{transform:translate(-2px,0)}}

/* layout */
html,body{height:100%;font-family:'Righteous',sans-serif;background:var(--bg-dark);color:var(--text);-webkit-font-smoothing:antialiased}
body::before{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,217,255,0.03) 0px,transparent 2px),radial-gradient(circle at 20% 80%, rgba(0,217,255,0.06),transparent 40%),radial-gradient(circle at 80% 20%, rgba(255,0,234,0.06),transparent 40%);pointer-events:none;z-index:0}
body::after{content:"";position:fixed;inset:0;background:linear-gradient(transparent 50%, rgba(0,217,255,0.02) 50%);background-size:100% 4px;pointer-events:none;z-index:1;animation:scanline 8s linear infinite;opacity:0.28}

header.topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:linear-gradient(135deg, rgba(10,10,18,0.95), rgba(26,26,46,0.95));border-bottom:3px solid var(--primary);position:sticky;top:0;z-index:60;backdrop-filter:blur(8px)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg-panel),var(--bg-dark));border:3px solid var(--primary);color:var(--primary);font-family:'Bebas Neue';font-weight:900;font-size:28px;box-shadow:0 0 10px rgba(0,217,255,0.12);transition:transform .25s;animation:neonPulse 6s ease-in-out infinite} 
.logo:hover{transform:scale(1.06);animation:glitchText 8s infinite}
.title h1{margin:0;font-size:28px;letter-spacing:6px;text-transform:uppercase;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 8px rgba(0,217,255,0.35));animation:pixelShift 12s linear infinite, glitchText 8s ease-in-out infinite}
.title .subtitle{margin:0;font-size:10px;color:var(--accent);letter-spacing:2px}

/* layout + panels */
.viewerWrap{display:flex;gap:12px;align-items:stretch;justify-content:center;width:100%;max-width:2000px;margin:16px auto;padding:0 12px}
.side-panel{width:520px;min-height:520px;background:linear-gradient(135deg, rgba(26,26,46,0.8), rgba(10,10,18,0.8));border:3px solid var(--primary);border-radius:8px;padding:12px;color:var(--text);overflow:hidden;z-index:10}
.side-panel .preview{width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000;border:2px solid rgba(0,217,255,0.04)}

/* Preview image styling — responsive, keeps aspect ratio and fits nicely into panel */
.side-panel .preview {
  display:flex;
  align-items:center;
  justify-content:center;
  padding:6px;
  background: transparent; /* keep your panel background */
}

/* Image itself */
.side-panel .preview .panel-preview-img {
  width: 100%;
  height: auto;
  max-height: 440px;       /* adjust to taste so it doesn't overflow the panel */
  object-fit: contain;     /* keep entire image visible */
  display: block;
  border-radius: 6px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.02);
}

/* If you want the image to fill and crop, use object-fit: cover instead:
.side-panel .preview .panel-preview-img { width:100%; height:100%; object-fit:cover; } */

/* Fullscreen note: by default your CSS hides side panels in fullscreen:
   body.fullscreen-active .side-panel { display: none !important; }
   If you'd like the previews visible in fullscreen, remove or override that rule. */

.viewport{flex:1 1 auto;min-height:70vh;display:flex;align-items:center;justify-content:center;position:relative;background:linear-gradient(135deg, rgba(26,26,46,0.6), rgba(10,10,18,0.8));border:3px solid var(--primary);box-shadow:0 0 30px rgba(0,217,255,0.12);overflow:hidden;touch-action:none;z-index:5}

/* fullscreen edge-to-edge & fixed on top */
body.fullscreen-active .viewport{position:fixed !important;inset:0 !important;width:100vw !important;height:100vh !important;clip-path:none !important;border:none !important;margin:0 !important;padding:0 !important;box-shadow:none !important;background:#000;z-index:200}
body.fullscreen-active .side-panel{display:none !important}

/* stage / pages */
.stageWrap{position:relative;width:100%;height:100%;overflow:hidden;will-change:transform;z-index:6}
.stage{display:flex;gap:6px;align-items:center;justify-content:center;transform-origin:50% 50%;will-change:transform;cursor:grab;touch-action:none}
.page{display:flex;align-items:center;justify-content:center;background:#000;position:relative;overflow:hidden;border:2px solid rgba(0,217,255,0.06);max-width:100%}
.page img{display:block;max-width:100%;max-height:94vh;object-fit:contain;-webkit-user-drag:none;pointer-events:none;user-select:none}
.spinner{position:absolute;width:40px;height:40px;border-radius:50%;border:3px solid transparent;border-top:3px solid var(--primary);border-right:3px solid var(--secondary);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* flash + slide animations */
.flashOverlay{pointer-events:none;position:absolute;inset:0;background:#000;opacity:0;transition:opacity 140ms linear;z-index:25}
.slide-out-left{transition:transform 160ms cubic-bezier(.2,.9,.2,1);transform:translateX(-18px)}
.slide-out-right{transition:transform 160ms cubic-bezier(.2,.9,.2,1);transform:translateX(18px)}
.slide-in-left{transition:transform 200ms cubic-bezier(.2,.9,.2,1);transform:translateX(0)}
.slide-in-right{transition:transform 200ms cubic-bezier(.2,.9,.2,1);transform:translateX(0)}

/* edge zones */
.edgeZone{position:absolute;top:0;height:100%;width:12%;z-index:30;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity 120ms}
.edgeZone.active{pointer-events:auto;opacity:1}
.edgeZone.left{left:0}.edgeZone.right{right:0}
.edgeArrow{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(0,217,255,0.08), rgba(255,0,234,0.06));border:2px solid rgba(0,217,255,0.12);color:var(--primary);cursor:pointer;user-select:none}

/* controls */
.controls{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;background:linear-gradient(135deg, rgba(26,26,46,0.9), rgba(10,10,18,0.9));border:3px solid var(--primary);clip-path:polygon(12px 0%,100% 0%,100% calc(100% - 12px), calc(100% - 12px) 100%,0% 100%,0% 12px);z-index:70;box-shadow:0 0 20px rgba(0,217,255,0.12)}
.controls .left, .controls .right{display:flex;gap:8px;align-items:center}
.btn{height:44px;min-width:44px;padding:0 14px;border:2px solid var(--primary);background:linear-gradient(135deg, rgba(0,217,255,0.06), rgba(255,0,234,0.04));color:var(--text);cursor:pointer;font-family:'Bebas Neue';font-weight:900;text-transform:uppercase}
/* FIT button style change (larger text + halftone overlay) */
.btn.primary{
  font-size:16px;
  line-height:1;
  padding:6px 18px;
  border:none;
  color:var(--bg-dark);
  background-image:
    linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%),
    repeating-linear-gradient(45deg, rgba(255,255,255,0.06) 0 3px, rgba(255,255,255,0.00) 3px 6px);
  background-blend-mode: overlay;
  box-shadow:0 0 20px rgba(0,217,255,0.8);
  border-radius:6px;
  position:relative;
  overflow:hidden;
}

/* floating header & controls */
body.fullscreen-active header.topbar{position:fixed;top:0;left:0;right:0;z-index:210;transition:transform .28s ease,opacity .28s ease;will-change:transform,opacity;background:linear-gradient(135deg, rgba(10,10,18,0.9), rgba(26,26,46,0.9))}
body.fullscreen-active .controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:210;transition:transform .28s ease,opacity .28s ease;will-change:transform,opacity}
body.fullscreen-active header.topbar.hidden{transform:translateY(-110%);opacity:0}
body.fullscreen-active .controls.hidden{transform:translateX(-50%) translateY(110%);opacity:0}

/* status/progress */
.status{padding:6px 12px;background:linear-gradient(135deg, rgba(255,237,0,0.08), rgba(255,237,0,0.04));border:2px solid var(--accent);color:var(--accent);font-family:'Bebas Neue';font-weight:900;text-transform:uppercase}
.progress-bar{position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(0,217,255,0.12);z-index:50}
.progress-fill{height:100%;width:0%;transition:width .28s ease-out;background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));box-shadow:0 0 8px rgba(0,217,255,0.08)}

select#chapter {
  background: linear-gradient(135deg, rgba(0,217,255,0.1), rgba(255,0,234,0.1));
  color: var(--accent);
  border: 2px solid var(--accent);
  padding: 8px 14px;
  clip-path: polygon(6px 0%, 100% 0%, 100% calc(100% - 6px), calc(100% - 6px) 100%, 0% 100%, 0% 6px);
  min-width: 160px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  font-family: 'Righteous', sans-serif;
}

select#chapter:hover {
  background: linear-gradient(135deg, rgba(0,217,255,0.2), rgba(255,0,234,0.2));
  box-shadow: 0 0 15px rgba(0,217,255,0.5);
}

select#chapter option {
  background: var(--bg-panel);
  color: var(--text);
}

@media(max-width:900px){.viewerWrap{flex-direction:column}.side-panel{width:100%;min-height:140px;display:flex;flex-direction:row;gap:8px;align-items:center;padding:8px}.edgeZone{width:18%}}
</style>
</head>
<body>

<header class="topbar" id="topbar">
  <div class="brand">
    <div class="logo">BWC</div>
    <div class="title">
      <h1>BATTLE BROS</h1>
      <p class="subtitle">/// GUESS WHO'S BACK IN TOWN? ///</p>
    </div>
  </div>

  <select id="chapter" aria-label="Select chapter"></select>
</header>

<main>
  <div class="viewerWrap">

    <aside class="side-panel left" id="leftPanel">
    <div class="preview" id="leftPreview" aria-hidden="false">
	<picture>
    <!-- Optional WebP version for smaller size / better quality where supported -->
		<source srcset="battlebroslogo.png" type="image/webp">
		<img
		class="panel-preview-img"
		src="battlebroslogo.png"
		alt="Left illustration preview"
		loading="lazy">
	</picture>
	</div>
    </aside>

    <section class="viewport" id="viewport" tabindex="0" aria-label="Comic viewport">
      <div class="stageWrap" id="stageWrap">
        <div class="stage" id="stage">
          <div class="page" id="leftPage" role="img" aria-hidden="false">
            <div class="spinner" id="leftSpinner" style="display:none;"></div>
            <img id="leftImg" src="" alt="" draggable="false" loading="lazy">
          </div>

          <div class="page" id="rightPage" aria-hidden="true" style="display:none;">
            <div class="spinner" id="rightSpinner" style="display:none;"></div>
            <img id="rightImg" src="" alt="" draggable="false" loading="lazy">
          </div>
        </div>

        <div class="flashOverlay" id="flashOverlay" aria-hidden="true"></div>
      </div>

      <div class="edgeZone left" id="edgeLeft" aria-hidden="true">
        <div class="edgeArrow" id="edgeLeftBtn" title="Previous page" role="button" aria-label="Previous page">
          <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
        </div>
      </div>
      <div class="edgeZone right" id="edgeRight" aria-hidden="true">
        <div class="edgeArrow" id="edgeRightBtn" title="Next page" role="button" aria-label="Next page">
          <svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
        </div>
      </div>

      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </section>

    <aside class="side-panel right" id="rightPanel">
    <div class="preview" id="rightPreview" aria-hidden="false">
	<picture>
	<source srcset="assets/previews/right-illustration.webp" type="image/webp">
	<img
      class="panel-preview-img"
      src="assets/previews/right-illustration.jpg"
      alt="Right illustration preview"
      loading="lazy">
	</picture>
	</div>
    </aside>

  </div>

  <div class="controls" id="controls" role="toolbar" aria-label="Reader controls">
    <div class="left">
      <button class="btn" id="prevBtn" type="button" aria-label="Previous page">◀ BACK</button>
      <button class="btn" id="nextBtn" type="button" aria-label="Next page">NEXT ▶</button>
      <span class="status" id="pageIndicator" aria-live="polite">PAGE 0 / 0</span>
    </div>

    <div class="right">
      <button class="btn" id="zoomOut" type="button" aria-label="Zoom out">−</button>
      <button class="btn primary" id="fitBtn" type="button" aria-label="Fit">⚡ FIT</button>
      <button class="btn" id="zoomIn" type="button" aria-label="Zoom in">+</button>
      <button class="btn" id="fullscreenBtn" type="button" aria-label="Toggle fullscreen">⛶</button>
    </div>
  </div>
</main>

<script>
(function(){
  'use strict';

  const STORAGE_KEY = 'battleBros_progress';
  const chapters = {
    "Chapter 1": ["chapters/01/01.png","chapters/01/02.png","chapters/01/03.png","chapters/01/04.png","chapters/01/05.png","chapters/01/06.png","chapters/01/07.png","chapters/01/08.png"],
    "Chapter 2": ["chapters/02/01.png","chapters/02/02.png","chapters/02/03.png","chapters/02/04.png","chapters/02/05.png","chapters/02/06.png","chapters/02/07.png","chapters/02/08.png"],
    "Chapter 3": ["chapters/03/01.png","chapters/03/02.png","chapters/03/03.png","chapters/03/04.png","chapters/03/05.png","chapters/03/06.png","chapters/03/07.png","chapters/03/08.png","chapters/03/09.png","chapters/03/10.png","chapters/03/11.png","chapters/03/12.png","chapters/03/13.png","chapters/03/14.png","chapters/03/15.png"],
    "Chapter 4": ["chapters/04/01.png","chapters/04/02.png","chapters/04/03.png","chapters/04/04.png","chapters/04/05.png","chapters/04/06.png","chapters/04/07.png","chapters/04/08.png","chapters/04/09.png","chapters/04/10.png"],
    "Chapter 5": ["chapters/05/01.png","chapters/05/02.png","chapters/05/03.png","chapters/05/04.png","chapters/05/05.png","chapters/05/06.png","chapters/05/07.png","chapters/05/08.png","chapters/05/09.png","chapters/05/10.png","chapters/05/11.png","chapters/05/12.png","chapters/05/13.png","chapters/05/14.png","chapters/05/15.png"],
    "Chapter 6": ["chapters/06/01.png","chapters/06/02.png","chapters/06/03.png","chapters/06/04.png","chapters/06/05.png","chapters/06/06.png","chapters/06/07.png","chapters/06/08.png","chapters/06/09.png","chapters/06/10.png","chapters/06/11.png","chapters/06/12.png","chapters/06/13.png","chapters/06/14.png","chapters/06/15.png"],
    "Chapter 7": ["chapters/07/01.png","chapters/07/02.png","chapters/07/03.png","chapters/07/04.png","chapters/07/05.png","chapters/07/06.png","chapters/07/07.png","chapters/07/08.png","chapters/07/09.png","chapters/07/10.png","chapters/07/11.png","chapters/07/12.png","chapters/07/13.png","chapters/07/14.png","chapters/07/15.png"],
    "Chapter 8": ["chapters/08/01.png","chapters/08/02.png","chapters/08/03.png","chapters/08/04.png","chapters/08/05.png","chapters/08/06.png","chapters/08/07.png","chapters/08/08.png","chapters/08/09.png","chapters/08/10.png","chapters/08/11.png","chapters/08/12.png","chapters/08/13.png","chapters/08/14.png","chapters/08/15.png"],
    "Chapter 9": ["chapters/09/01.png","chapters/09/02.png","chapters/09/03.png","chapters/09/04.png","chapters/09/05.png","chapters/09/06.png","chapters/09/07.png","chapters/09/08.png","chapters/09/09.png","chapters/09/10.png","chapters/09/11.png","chapters/09/12.png","chapters/09/13.png","chapters/09/14.png","chapters/09/15.png"]
  };

  const state = {
    currentChapter: '',
    pages: [],
    pageIndex: 0,
    scale: 1,
    pan: {x:0,y:0},
    isDragging:false,
    dragStart:{x:0,y:0},
    panStart:{x:0,y:0},
    touchStart:null,
    pinchDistance:null,
    pinchScale:1,
    pinchCenter:null,
    pointers:new Map(),
    imageCache:new Map(),
    isTransitioning:false,
    rafId:null,
    prevTransformOrigin:null
  };

  let el = {};

  function initRefs(){
    el = {
      chapter: document.getElementById('chapter'),
      stageWrap: document.getElementById('stageWrap'),
      stage: document.getElementById('stage'),
      viewport: document.getElementById('viewport'),
      topbar: document.getElementById('topbar'),
      controls: document.getElementById('controls'),
      leftPage: document.getElementById('leftPage'),
      rightPage: document.getElementById('rightPage'),
      leftImg: document.getElementById('leftImg'),
      rightImg: document.getElementById('rightImg'),
      leftSpinner: document.getElementById('leftSpinner'),
      rightSpinner: document.getElementById('rightSpinner'),
      indicator: document.getElementById('pageIndicator'),
      progressFill: document.getElementById('progressFill'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      zoomIn: document.getElementById('zoomIn'),
      zoomOut: document.getElementById('zoomOut'),
      fitBtn: document.getElementById('fitBtn'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      flash: document.getElementById('flashOverlay'),
      edgeLeft: document.getElementById('edgeLeft'),
      edgeRight: document.getElementById('edgeRight'),
      edgeLeftBtn: document.getElementById('edgeLeftBtn'),
      edgeRightBtn: document.getElementById('edgeRightBtn'),
      leftPreview: document.getElementById('leftPreview'),
      rightPreview: document.getElementById('rightPreview'),
      shortcuts: document.getElementById('shortcuts'),
      progressBar: document.getElementById('progressFill')
    };
  }

  function preloadImage(url){
    if(!url) return Promise.reject('no-url');
    if(state.imageCache.has(url)) return state.imageCache.get(url);
    const p = new Promise((resolve,reject)=>{
      const i = new Image();
      i.onload = ()=>resolve(i);
      i.onerror = ()=>reject(new Error('image load error: '+url));
      i.src = url;
    });
    state.imageCache.set(url,p);
    if(state.imageCache.size>60){
      const k = state.imageCache.keys().next().value;
      state.imageCache.delete(k);
    }
    return p;
  }

  function loadImageDirect(imgEl, spinnerEl, url){
    if(!imgEl) return;
    if(!url){ imgEl.removeAttribute('src'); imgEl.alt=''; if(spinnerEl) spinnerEl.style.display='none'; return; }
    if(spinnerEl) spinnerEl.style.display='';
    function done(){ if(spinnerEl) spinnerEl.style.display='none'; imgEl.removeEventListener('load',done); imgEl.removeEventListener('error',done); }
    imgEl.addEventListener('load',done); imgEl.addEventListener('error',done);
    imgEl.alt = `${state.currentChapter} — page ${state.pages.indexOf(url)+1}`;
    imgEl.src = url;
    try{ preloadImage(url).catch(()=>{}); }catch(e){}
  }

  function saveProgress(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({chapter:state.currentChapter,page:state.pageIndex,timestamp:Date.now()})); }catch(e){} }
  function loadProgress(){ try{ const s = localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):null;}catch(e){return null;} }

  function isTwoPageMode(){ return window.innerWidth>=900; }
  function canShowTwoPages(){ return isTwoPageMode() && state.pageIndex+1 < state.pages.length; }

  function render(){
    state.isTransitioning = true;
    if(el.stage) el.stage.classList.add('transitioning');
    setTimeout(()=>{ if(el.stage) el.stage.classList.remove('transitioning'); state.isTransitioning=false; },200);

    const two = canShowTwoPages();
    const left = state.pages[state.pageIndex] || '';
    const right = state.pages[state.pageIndex+1] || '';

    if(!two){
      if(el.rightPage) el.rightPage.style.display='none';
      loadImageDirect(el.leftImg, el.leftSpinner, left);
    } else {
      if(el.rightPage) el.rightPage.style.display='';
      loadImageDirect(el.leftImg, el.leftSpinner, left);
      loadImageDirect(el.rightImg, el.rightSpinner, right);
    }

    updateUI();
    const start = state.pageIndex + 2;
    for(let i=start;i<Math.min(state.pages.length,start+8);i++) preloadImage(state.pages[i]).catch(()=>{});
  }

  function updateUI(){
    const total = state.pages.length || 1;
    const current = state.pageIndex + 1;
    const two = canShowTwoPages();
    if(el.indicator) el.indicator.textContent = two ? `PAGE ${current}-${Math.min(current+1,total)} / ${total}` : `PAGE ${current} / ${total}`;

    // Disable Next when:
    // - on the final single page (pageIndex >= total-1), OR
    // - in two-page mode and the right-side page is the last page (i.e. pageIndex +1 === total-1)
    let disableNext = false;
    if (state.pageIndex >= total - 1) {
      disableNext = true;
    } else if (two && state.pageIndex + 1 === total - 1) {
      disableNext = true;
    }

    if (el.progressFill) el.progressFill.style.width = ((Math.min(total, state.pageIndex + (two ? 2 : 1)) / total) * 100) + '%';
    if (el.prevBtn) el.prevBtn.disabled = state.pageIndex === 0;
    if (el.nextBtn) el.nextBtn.disabled = disableNext;
  }

  function animatePageChange(direction,onMid){
    if(state.isTransitioning) return;
    state.isTransitioning = true;
    if(!el.stageWrap){ if(typeof onMid==='function') onMid(); state.isTransitioning=false; return; }
    el.stageWrap.classList.remove('slide-in-left','slide-in-right','slide-out-left','slide-out-right');
    void el.stageWrap.offsetWidth;
    el.stageWrap.classList.add(direction==='next' ? 'slide-out-left' : 'slide-out-right');
    if(el.flash) setTimeout(()=>{ el.flash.style.opacity='1'; },80);
    setTimeout(()=>{
      if(typeof onMid==='function') onMid();
      if(el.flash){ el.flash.style.transition='opacity 160ms linear'; el.flash.style.opacity='0'; }
      el.stageWrap.classList.remove('slide-out-left','slide-out-right');
      if(direction==='next'){ el.stageWrap.style.transform='translateX(18px)'; requestAnimationFrame(()=>{ el.stageWrap.classList.add('slide-in-left'); el.stageWrap.style.transform='translateX(0)'; }); }
      else { el.stageWrap.style.transform='translateX(-18px)'; requestAnimationFrame(()=>{ el.stageWrap.classList.add('slide-in-right'); el.stageWrap.style.transform='translateX(0)'; }); }
      setTimeout(()=>{ el.stageWrap.classList.remove('slide-in-left','slide-in-right'); el.stageWrap.style.transform=''; state.isTransitioning=false; },220);
    },200);
  }

  function prevPage(){ if(state.isTransitioning) return; const newIndex = isTwoPageMode()?Math.max(0,state.pageIndex-2):Math.max(0,state.pageIndex-1); if(newIndex===state.pageIndex) return; animatePageChange('prev', ()=>{ state.pageIndex=newIndex; render(); saveProgress(); }); }

  function nextPage(){
    if (state.isTransitioning) return;
    const two = isTwoPageMode();
    const total = state.pages.length;

    // If in two-page mode and the right page is already the last page,
    // don't advance to the single last page — treat as end.
    if (two && state.pageIndex + 1 === total - 1) {
      // Show ending card (same behavior as being at the very end)
      showEndingCard();
      return;
    }

    // Check if we're at the last page - go to ending card
    if (state.pageIndex >= total - 1) {
      showEndingCard();
      return;
    }

    let newIndex;
    if (two) {
      // If advancing 2 would go past end, go to last page
      if (state.pageIndex + 2 >= total) {
        newIndex = total - 1;
      } else {
        newIndex = state.pageIndex + 2;
      }
    } else {
      newIndex = Math.min(total - 1, state.pageIndex + 1);
    }

    animatePageChange('next', () => {
      state.pageIndex = newIndex;
      render();
      saveProgress();
    });
  }

  // pointer / pan / pinch (unchanged)
  function getDist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.sqrt(dx*dx+dy*dy); }

  function onPointerDown(e){ try{ e.target.setPointerCapture(e.pointerId); }catch(err){} state.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); const count = state.pointers.size; if(count===1){ state.touchStart={x:e.clientX,y:e.clientY,time:Date.now()}; state.dragStart={x:e.clientX,y:e.clientY}; state.panStart={...state.pan}; state.isDragging = state.scale > 1.01; } else if(count===2){ const pts = Array.from(state.pointers.values()); state.pinchDistance = getDist(pts[0],pts[1]); state.pinchScale = state.scale; state.pinchCenter = {x:(pts[0].x+pts[1].x)/2,y:(pts[0].y+pts[1].y)/2}; state.panStart = {...state.pan}; state.isDragging=false; } if(document.fullscreenElement){ const nearTop = e.clientY < 150 || e.clientY > window.innerHeight - 200; if(nearTop) showControlsBarAt(e.clientY); } }

  function onPointerMove(e){ if(!state.pointers.has(e.pointerId)) return; state.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}); updateEdgeZonesByPointer(e.clientX,e.clientY); if(state.pointers.size===1){ if(state.isDragging){ const p = Array.from(state.pointers.values())[0]; state.pan.x = state.panStart.x + (p.x - state.dragStart.x); state.pan.y = state.panStart.y + (p.y - state.dragStart.y); applyTransform(); } } else if(state.pointers.size>=2){ const pts = Array.from(state.pointers.values()); const newDist = getDist(pts[0],pts[1]); if(state.pinchDistance && state.pinchScale != null){ const newScale = Math.max(0.05, Math.min(20, state.pinchScale * (newDist / state.pinchDistance))); const newCenter = {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2}; state.scale = newScale; state.pan.x = state.panStart.x + (newCenter.x - state.pinchCenter.x); state.pan.y = state.panStart.y + (newCenter.y - state.pinchCenter.y); applyTransform(); } } }

  function onPointerUp(e){ try{ e.target.releasePointerCapture(e.pointerId); }catch(err){} state.pointers.delete(e.pointerId); if(state.pointers.size===0){ const wasPinching = state.pinchDistance !== null; if(!wasPinching && state.touchStart){ const dx = e.clientX - state.touchStart.x; const dy = e.clientY - state.touchStart.y; const dt = Date.now() - state.touchStart.time; if(Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) && dt < 500 && state.scale <= 1.01){ dx>0?prevPage():nextPage(); } } state.isDragging=false; state.touchStart=null; state.pinchDistance=null; state.pinchCenter=null; state.pinchScale=state.scale; } else if(state.pointers.size===1){ const rem = Array.from(state.pointers.values())[0]; state.dragStart = {x:rem.x,y:rem.y}; state.panStart = {...state.pan}; state.isDragging = state.scale > 1.01; } }

  function onWheel(e){ if(e.ctrlKey){ e.preventDefault(); state.scale = Math.max(0.05, Math.min(20, state.scale + (e.deltaY > 0 ? -0.1 : 0.1))); applyTransform(); } }

  function applyTransform(){ if(state.rafId) cancelAnimationFrame(state.rafId); state.rafId = requestAnimationFrame(()=>{ if(el.stage) el.stage.style.transform = `translate(${state.pan.x}px, ${state.pan.y}px) scale(${state.scale})`; state.rafId = null; }); }

  // edge zones
  function updateEdgeZonesByPointer(x,y){
    if(!el.viewport) return;
    if(state.isDragging || state.pointers.size > 0){ if(el.edgeLeft) el.edgeLeft.classList.remove('active'); if(el.edgeRight) el.edgeRight.classList.remove('active'); if(el.viewport) el.viewport.style.cursor = ''; return; }
    const rect = el.viewport.getBoundingClientRect();
    const relX = x - rect.left;
    const pct = relX / rect.width;
    const threshold = 0.12;
    if(pct < threshold){ if(el.edgeLeft) el.edgeLeft.classList.add('active'); if(el.edgeRight) el.edgeRight.classList.remove('active'); if(el.viewport) el.viewport.style.cursor = 'pointer'; }
    else if(pct > 1 - threshold){ if(el.edgeRight) el.edgeRight.classList.add('active'); if(el.edgeLeft) el.edgeLeft.classList.remove('active'); if(el.viewport) el.viewport.style.cursor = 'pointer'; }
    else { if(el.edgeLeft) el.edgeLeft.classList.remove('active'); if(el.edgeRight) el.edgeRight.classList.remove('active'); if(el.viewport) el.viewport.style.cursor = ''; }
  }

  // fullscreen floating menu
  let hideTimer = null;
  let mouseOverControls = false;
  function showControlsBar(){ if(el.topbar) el.topbar.classList.remove('hidden'); if(el.controls) el.controls.classList.remove('hidden'); if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } if(document.fullscreenElement && !mouseOverControls){ hideTimer = setTimeout(()=>{ if(!mouseOverControls){ if(el.topbar) el.topbar.classList.add('hidden'); if(el.controls) el.controls.classList.add('hidden'); } }, 1200); } }
  function showControlsBarAt(y){ const nearTop = y < 150; const nearBottom = y > window.innerHeight - 200; if(document.fullscreenElement){ if(nearTop || nearBottom) showControlsBar(); } else showControlsBar(); }

  function onFullscreenChange(){
	if (document.fullscreenElement) {
		document.body.classList.add('fullscreen-active');
	if (el.fullscreenBtn) el.fullscreenBtn.textContent = '✕';
		showControlsBar();

  // Wait two animation frames so layout is stable (viewport size & image layout updated),
  // then run the fit routine that sizes the page top-to-bottom.
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      if (typeof fitHeightFullscreen === 'function') {
        try {
          fitHeightFullscreen();
        } catch (e) {
          console.warn('[Reader] fitHeightFullscreen failed on fullscreen enter', e);
        }
      }
    });
  });
} else {
  // exiting fullscreen (existing code)
  document.body.classList.remove('fullscreen-active');
  if (el.fullscreenBtn) el.fullscreenBtn.textContent = '⛶';
  if (el.topbar) el.topbar.classList.remove('hidden');
  if (el.controls) el.controls.classList.remove('hidden');
  if (el.stage && state.prevTransformOrigin !== null) {
    el.stage.style.transformOrigin = state.prevTransformOrigin;
    state.prevTransformOrigin = null;
  }
  if (hideTimer) clearTimeout(hideTimer);
}
}

  // FIT: improved — compute based on current rendered image height (not naturalHeight), so FIT always makes the page fill viewport height
  function fitToScreenSmart(){ if(document.fullscreenElement){ fitHeightFullscreen(); } else { state.scale = 1; state.pan = {x:0,y:0}; applyTransform(); } }

  function fitHeightFullscreen(){
    const img = el.leftImg;
    if(!img){ state.scale = 1; applyTransform(); return; }

    if(el.stage){
      if(state.prevTransformOrigin === null){
        state.prevTransformOrigin = window.getComputedStyle(el.stage).transformOrigin || '50% 50%';
      }
      el.stage.style.transformOrigin = 'top center';
    }

    const vpH = el.viewport.clientHeight;

    const doFit = () => {
      const rect = img.getBoundingClientRect();
      let baselineHeight = rect.height || img.naturalHeight || img.height || 1;
      let targetScale = vpH / baselineHeight;
      targetScale = Math.max(0.05, Math.min(20, targetScale));
      state.scale = targetScale;
      state.pan.x = 0;
      state.pan.y = 0;
      applyTransform();
    };

    const prevScale = state.scale;
    const prevPan = {...state.pan};
    state.scale = 1;
    state.pan = {x:0,y:0};
    applyTransform();

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        try {
          doFit();
        } catch (e) {
          console.error('[Reader] fit error', e);
          state.scale = prevScale;
          state.pan = prevPan;
          applyTransform();
        }
      });
    });
  }

  // attach UI handlers
  function attachUIHandlers(){
    if(el.prevBtn) el.prevBtn.addEventListener('click', prevPage);
    if(el.nextBtn) el.nextBtn.addEventListener('click', nextPage);
    if(el.zoomIn) el.zoomIn.addEventListener('click', ()=>{ state.scale = Math.min(20, state.scale * 1.2); applyTransform(); });
    if(el.zoomOut) el.zoomOut.addEventListener('click', ()=>{ state.scale = Math.max(0.05, state.scale / 1.2); applyTransform(); });
    if(el.fitBtn) el.fitBtn.addEventListener('click', fitToScreenSmart);
    if(el.fullscreenBtn) el.fullscreenBtn.addEventListener('click', ()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen(); });

    if(el.edgeLeftBtn) el.edgeLeftBtn.addEventListener('click', (e)=>{ e.stopPropagation(); prevPage(); });
    if(el.edgeRightBtn) el.edgeRightBtn.addEventListener('click', (e)=>{ e.stopPropagation(); nextPage(); });

    if(el.stage) el.stage.addEventListener('pointerdown', onPointerDown);
    window.addEventListener('pointermove', onPointerMove);
    window.addEventListener('pointerup', onPointerUp);
    window.addEventListener('pointercancel', onPointerUp);
    if(el.stage) el.stage.addEventListener('wheel', onWheel, {passive:false});

    if(el.viewport){
      el.viewport.addEventListener('mousemove', (e)=>updateEdgeZonesByPointer(e.clientX,e.clientY));
      el.viewport.addEventListener('pointerup', (e)=>{
        if(!state.isDragging && state.pointers.size===0){
          const now = Date.now();
          if(state._lastTap && now - state._lastTap < 300){
            state._lastTap = 0;
            if(document.fullscreenElement) fitHeightFullscreen();
            else { state.scale=1; state.pan={x:0,y:0}; applyTransform(); }
          } else state._lastTap = now;
        }
      });
    }

    document.addEventListener('keydown', (e)=>{
      switch(e.key){
        case 'ArrowLeft': e.preventDefault(); prevPage(); break;
        case 'ArrowRight': e.preventDefault(); nextPage(); break;
        case '+': case '=': e.preventDefault(); state.scale = Math.min(20, state.scale * 1.2); applyTransform(); break;
        case '-': e.preventDefault(); state.scale = Math.max(0.05, state.scale / 1.2); applyTransform(); break;
        case '0': e.preventDefault(); state.scale = 1; state.pan = {x:0,y:0}; applyTransform(); break;
        case 'f': case 'F': e.preventDefault(); if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen(); break;
        case '?': if(el.shortcuts){ el.shortcuts.classList.toggle('show'); setTimeout(()=>el.shortcuts.classList.remove('show'),5000); } break;
      }
    });

    document.addEventListener('fullscreenchange', onFullscreenChange);
    document.addEventListener('mousemove', (e)=>{ if(document.fullscreenElement){ const nearTop = e.clientY<150 || e.clientY>window.innerHeight-200; if(nearTop) showControlsBar(); } });

    if(el.topbar){
      el.topbar.addEventListener('mouseenter', ()=>{ mouseOverControls=true; if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } });
      el.topbar.addEventListener('mouseleave', ()=>{ mouseOverControls=false; showControlsBar(); });
    }
    if(el.controls){
      el.controls.addEventListener('mouseenter', ()=>{ mouseOverControls=true; if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } });
      el.controls.addEventListener('mouseleave', ()=>{ mouseOverControls=false; showControlsBar(); });
    }
  }

  function init(){
    initRefs();
    if(el.chapter){
      Object.keys(chapters).forEach(name=>{
        const o=document.createElement('option'); o.value=name; o.textContent=name; el.chapter.appendChild(o);
      });
    }

    const saved = loadProgress();
    if(saved && chapters[saved.chapter]){ state.currentChapter = saved.chapter; state.pages = chapters[saved.chapter]; state.pageIndex = saved.page || 0; }
    else { const first = Object.keys(chapters)[0]; state.currentChapter = first; state.pages = chapters[first] || []; state.pageIndex = 0; }

    if(el.chapter) el.chapter.value = state.currentChapter;
    if(el.chapter) el.chapter.addEventListener('change', (e)=>{ const v=e.target.value; if(chapters[v]){ state.currentChapter=v; state.pages=chapters[v]; state.pageIndex=0; state.scale=1; state.pan={x:0,y:0}; render(); saveProgress(); } });

    attachUIHandlers();
    render();
    console.log('[Reader] init complete');
  }

  if(document.readyState==='complete' || document.readyState==='interactive') setTimeout(init,0); else document.addEventListener('DOMContentLoaded',init);

})();
</script>
</body>
</html>
